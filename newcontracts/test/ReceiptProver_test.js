
const BlockRecorder = artifacts.require('./BlockRecorder.sol');
const ReceiptProver = artifacts.require('./ReceiptProver.sol');

const block1 = "0xf90224a0fd45231c2e0021ddf741198d194ac0603a02a2b8f51eeea6ecb5209fb44e1101a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794ec4ddeb4380ad69b3e509baad9f158cdf4e4681da021c25b2dc4609a95ab510fb97aeabe450a53fdccdbb62ef50ea6946608c1a5a1a0a84b7e575405c273178035d3e9abe5d550761b6e8321c0d3dd58c4146dac25a6a0c93d7e93840d3c46a74c10e61a8afe3bef3e8d78ce1040f53c6c4178652cb1beb9010000000000000000000000000000000000000000002000000000200000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000100000080000000000000000000000000000080000000000000000000000000000000000000008000000000000000000000000000000000010000000000000000000000080000000100000020000000000000000000000000000001000000000020000000001000000000000018000000000000020000000000000200040100000000000000000000000000000000000000000000000000000000000000000000000018202de8367c28083055375845d5c481180800080b850711101000000000000000000000000000000000000000000000000000000000000000000403ac00d7ab9e50ae959b7fb5e7f6d6962ea1bc360d56b10e73ea005d1a2795d11485c5dffff7f2133080000";
const hash1 = "0xc4d15aa92e1eb489b383c52e0c52607ab7f62dc550d4f8d36d5da50031ff633d";
const trr1 = "0xc93d7e93840d3c46a74c10e61a8afe3bef3e8d78ce1040f53c6c4178652cb1be"

const nodes1 = [
    "f9010e0183055375b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c08305537501",
    "7006004a79cce4182705422141f1a8477788a42360560b09e00032372c141eeac77c89000111",
    "4f267006029ca5b1da63038974cc58cb8feb6bfe3bfc138f1ffa24012dd3682b354295e7c900038b267006004a79cce4182705422141f1a8477788a42360560b09e00032372c141eeac77c89000111fde804"                
];

contract('ReceiptProver', function (accounts) {
    beforeEach(async function () {
        this.recorder = await BlockRecorder.new();
        this.prover = await ReceiptProver.new(this.recorder.address);
    });
    
    it('prove receipt in block', async function () {
        await this.recorder.recordBlock(block1);
        
        const prefsuf = calculatePrefixesSuffixes(nodes1);

        const result = await this.prover.receiptIsValid(hash1, '0x' + nodes1[0], prefsuf.prefixes, prefsuf.suffixes);
        
        assert.equal(result, true);
    });
});

function calculatePrefixesSuffixes(nodes) {
    const prefixes = [];
    const suffixes = [];
    const ns = [];
    
    for (let k = 0, l = nodes.length; k < l; k++) {
        if (k + 1 < l && nodes[k+1].indexOf(nodes[k]) >= 0)
            continue;
        
        ns.push(nodes[k]);
    }
    
    let hash = web3.utils.sha3(Buffer.from(ns[0], 'hex'));
    
    if (hash.substring(0, 2).toLowerCase() === '0x')
        hash = hash.substring(2);
    
    prefixes.push('0x');
    suffixes.push('0x');
    
    for (let k = 1, l = ns.length; k < l; k++) {
        const p = ns[k].indexOf(hash);
        
        prefixes.push('0x' + ns[k].substring(0, p));
        suffixes.push('0x' + ns[k].substring(p + hash.length));
        
        hash = web3.utils.sha3(Buffer.from(ns[k], 'hex'));
        
        if (hash.substring(0, 2).toLowerCase() === '0x')
            hash = hash.substring(2);
    }
    
    return { prefixes: prefixes, suffixes: suffixes };
}

